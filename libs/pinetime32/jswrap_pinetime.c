#include <jswrap_pinetime.h>
#include "jsinteractive.h"
#include "jsdevices.h"
#include "jsnative.h"
#include "jshardware.h"
#include "jsdevices.h"
#include "jspin.h"
#include "jstimer.h"
#include "jswrap_promise.h"
#include "jswrap_date.h"
#include "jswrap_math.h"
#include "jswrap_storage.h"
#include "jswrap_array.h"
#include "jswrap_arraybuffer.h"
#include "jswrap_heatshrink.h"
#include "jswrap_espruino.h"
#include "jswrap_terminal.h"
#include "jsflash.h"
#include "graphics.h"
#include "bitmap_font_6x8.h"
#ifndef EMULATED
#include "jswrap_bluetooth.h"
#include "app_timer.h"
#include "nrf_gpio.h"
#include "nrf_delay.h"
#include "nrf_soc.h"
#include "nrf_saadc.h"
#include "nrf5x_utils.h"

#include "bluetooth.h" // for self-test
#include "jsi2c.h" // accelerometer/etc
#endif

#include "jswrap_graphics.h"
#if defined(LCD_CONTROLLER_ST7789V) || defined(LCD_CONTROLLER_ST7735) || defined(LCD_CONTROLLER_GC9A01)
#include "lcd_spilcd.h"
#endif



/*JSON{
    "type": "class",
    "class" : "Pinetime"
}
Class containing utility functions for Pinetime
*/

JsVar *getLogo() {
  const unsigned char img_compressed[] = {
    0xca,0x4d,0xa0,0x21,0x03,0x61,0x00,0x20,0x68,0x01,0x13,0x60,0x38,0x08,0x04,0x10,0x6a,0x74,0x60,0x49,0xf8,0x00,0x88,0xff,0xff,0xff,0xe0,0x08,0x9b,0x7f,0x08,0x83,0xff,0xfc,0x04,0x4c,0x86,0x01,0x03,0xe0,0x12,0x0d,0x9f,0x8d,0x81,0x83,0x09,0x0c,0x88,0x7f,0xa0,0x10,0x7f,0xe4,0x80,0x48,0x64,0x40,0x08,0x15,0x88,0x48,0x64,0x48,0x06,0x14,0x08,0x48,0x64,0x0c,0x1a,0x1c,0xc8,0x48,0x64,0x88,0x76,0x18,0x90,0xc1,0x90,0x83,0xb0,0xc0,0x04,0xc9,0x84,0x82,0xc3,0x81,0x82,0x30,0x44,0x81,0x3b,0x03,0x89,0xa5,0x81,0x06,0x07,0x0e,0x0b,0x8b,0x24,0x12,0x06,0xe1,0x04,0x18,0x1c,0x04,0x2e,0x20,0x90,0x58,0x8b,0x7c,0x10,0x60,0x71,0xe1,0x21,0x70,0x7c,0x00,0x90,0x43,0x70,0xa2,0x40,0x6c,0x02,0x40,0x7e,0x17,0x8f,0x0f,0x7e,0x03,0xf8,0xbf,0xe3,0xa7,0xbf,0x3f,0x04,0xfc,0x48,0x3e,0x3a,0x7f,0xf8,0x9f,0xf1,0xff,0x1e,0x3f,0xff,0xfe,0x0f,0xf8,0x24,0x8a,0x24,0x04,0x18,0x0e,0x1f,0x3c,0x24,0x06,0x7f,0xff,0xf8,0x7c,0xf8,0x16,0x42,0x90,0x33,0xf3,0x70,0x58,0xe9,0xf5,0xe3,0xe1,0xe1,0xf0,0x78,0xfc,0xfc,0xf8,0x74,0x72,0x0c,0x24,0x06,0xcd,0x10,0x37,0x03,0xf0,0xf1,0xf0,0xf1,0xf0,0xf3,0x70,0x33,0xcb,0xc5,0xe4,0x2e,0x08,0x90,0x18,0x35,0x80,0x48,0x0f,0xf8,0x18,0x0c,0xe3,0xff,0xf1,0x12,0x03,0xc3,0xc3,0xe7,0xff,0xc2,0x40,0xac,0xe4,0x90,0x7f,0x10,0x01,0x20,0x5f,0xf1,0x20,0x53,0x8b,0xcb,0x0c,0x11,0x20,0x53,0xe1,0x20,0x2c,0x60,0x41,0x80,0xfc,0x12,0x60,0x89,0x02,0xcf,0x03,0xc1,0x49,0x85,0x70,0x37,0x02,0x24,0x0d,0x70,0x10,0x90,0x25,0x50,0x22,0x40,0xa0,0x22,0x41,0x89,0x22,0x63,0xa3,0xc2,0x40,0x66,0x16,0x49,0x80,0x90,0x4c,0x3f,0xfa,0x3f,0xce,0x0b,0x83,0x78,0xff,0xa4,0xc1,0x81,0xc1,0xaf,0xc2,0x41,0x67,0xfc,0x1f,0xe0,0x5c,0x2c,0x3a,0xe0,0x30,0x08,0x22,0x40,0xbc,0x3c,0x3c,0x0f,0xe2,0x1e,0x24,0x0a,0xe0,0xdd,0x0e,0x08,0xdd,0x06,0x20,0xfb,0x10,0x00,0x30,0x90,0x18,0x1f,0x00,0x48,0x08,0x44,0xb1,0x20,0x53,0x81,0x22,0x00,0x40,0x84,0x87,0x80,0x01,0x12,0x25,0x13,0x12,0x23,0x30,0x12,0x21,0x12,0x12,0x19,0x26,0x12,0x07,0x20,0x12,0x18,0x0d,0x0e,0x44,0x24,0x30,0x1a,0x18,0x58,0x41,0x21,0x27,0xc0,0xe8,0x42,0x43,0x22,0x1f,0xe2,0x40,0x3f,0x81,0x21,0x90,0x18,0x04,0xff,0xff,0xf0,0x79,0x02,0x00,0x2e,0x10,0x04,0x0d,0xe4,0x08,0x00,0xbb,0x80,0x0c,0x2b,0xc0,0x44,0xc8,0x0f,0xfc,0x00,0x0f,0xf0,0x22,0x61,0x28,0x28,0x81,0x20,0xd3,0x78,0x40,0x20,0x59,0xc1,0x89,0x0c,0x80,0x09,0x01 
  };
  JsVar *v = jsvNewNativeString((char*)&img_compressed[0], sizeof(img_compressed));
  JsVar *ab = jswrap_heatshrink_decompress(v);
  JsVar *img = jsvGetArrayBufferBackingString(ab, NULL);
  jsvUnLock2(v,ab);
  return img;
}

void graphicsInternalFlip() {
  //lcdFlip_SPILCD(&graphicsInternal);
}

/// Flip buffer contents with the screen.
void lcd_flip(JsVar *parent, bool all) {
#ifdef LCD_WIDTH
  if (all) {
    graphicsInternal.data.modMinX = 0;
    graphicsInternal.data.modMinY = 0;
    graphicsInternal.data.modMaxX = LCD_WIDTH-1;
    graphicsInternal.data.modMaxY = LCD_HEIGHT-1;
  }
  graphicsInternalFlip();
#endif
}

/*JSON{
  "type" : "hwinit",
  "generate" : "jswrap_pinetime_hwinit"
}*/
NO_INLINE void jswrap_pinetime_hwinit() {

    jswrap_ble_setTxPower(4);

    // Touch init
    jshPinOutput(TOUCH_PIN_RST, 0);
    jshDelayMicroseconds(1000);
    jshPinOutput(TOUCH_PIN_RST, 1);


    graphicsStructInit(&graphicsInternal, LCD_WIDTH, LCD_HEIGHT, LCD_BPP);

    graphicsInternal.data.type = JSGRAPHICSTYPE_LCD_SPI_UNBUF;
    graphicsInternal.data.flags = 0;
    graphicsInternal.data.fontSize = JSGRAPHICS_FONTSIZE_6X8+1; // 4x6 size is default

    //lcdInit_SPILCD(&graphicsInternal);

    graphicsSetCallbacks(&graphicsInternal);
    
    graphicsFillRect(&graphicsInternal, 0,0,LCD_WIDTH-1,LCD_HEIGHT-1, GRAPHICS_COL_RGB_TO_16(0,0,255));

}

/*JSON{
  "type" : "init",
  "generate" : "jswrap_pinetime_init"
}*/
NO_INLINE void jswrap_pinetime_init() {
    
    bool firstRun = jsiStatus & JSIS_FIRST_BOOT; // is this the first time jswrap_pinetime_init was called?

    if (firstRun) {
      // BT1 Enable
      jshPinOutput(15, true);

      jshPinOutput(LCD_BL, true); // backlight
      
    }

    // Create backing graphics object for LCD
    JsVar *graphics = jspNewObject(0, "Graphics");
    // if there's nothing in the Graphics object, we assume it's for the built-in graphics
    if (!graphics) return; // low memory
    // add it as a global var
    jsvObjectSetChild(execInfo.root, "g", graphics);
    jsvObjectSetChild(execInfo.hiddenRoot, JS_GRAPHICS_VAR, graphics);
    graphicsInternal.graphicsVar = graphics;

    // Create 'flip' fn
    JsVar *fn = jsvNewNativeFunction((void (*)(void))lcd_flip, JSWAT_VOID|JSWAT_THIS_ARG|(JSWAT_BOOL << (JSWAT_BITS*1)));
    jsvObjectSetChildAndUnLock(graphics,"flip",fn);


    int x = LCD_WIDTH/2;
    int y = LCD_HEIGHT/2;
    graphicsFillRect(&graphicsInternal, x-49, y-19, x+49, y+19, graphicsTheme.bg);
    graphicsInternal.data.fgColor = graphicsTheme.fg;
    graphicsDrawRect(&graphicsInternal, x-50, y-20, x+50, y+20);
    y -= 4;
    x -= 4*6;
    const char *s = "Loading...";
    while (*s) {
        graphicsDrawChar6x8(&graphicsInternal, x, y, *s, 1, 1, false);
        x+=6;
        s++;
    }
}


/*JSON{
  "type" : "kill",
  "generate" : "jswrap_pinetime_kill"
}*/
void jswrap_pinetime_kill() {

}



/*JSON{
    "type" : "staticmethod",
    "class" : "Pinetime",
    "name" : "isCharging",
    "generate" : "jswrap_pinetime_isCharging",
    "return" : ["bool","Is the battery charging or not?"],
    "ifdef" : "PINETIME32"
}
*/
// emscripten bug means we can't use 'bool' as return value here!
int jswrap_pinetime_isCharging() {
#ifdef BAT_PIN_CHARGING
  return !jshPinGetValue(BAT_PIN_CHARGING);
#else
  return 0;
#endif
}

/// get battery percentage
JsVarInt jswrap_pinetime_getBattery() {
    return 50;
}